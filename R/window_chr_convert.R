# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

# parse_logical(x, na = c("", "NA"), locale = default_locale(),
#               trim_ws = TRUE)
#
# parse_integer(x, na = c("", "NA"), locale = default_locale(),
#               trim_ws = TRUE)
#
# parse_double(x, na = c("", "NA"), locale = default_locale(),
#              trim_ws = TRUE)
#
# parse_factor(x, levels, ordered = FALSE, na = c("", "NA"),
#              locale = default_locale(), include_na = TRUE, trim_ws = TRUE)

#' Rcmdr windows for variable class conversion
#'
#' @export
#' @keywords internal
#' @family conversion
#'
window_chr_convert <- function() {
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    initializeDialog(title = gettext_Bio("Convert text variables into other classes"))
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    defaults <- list(suffix = gettext_Bio("<automatic suffix>"),
                     into = "factor",
                     which_names = "new_names",
                     variables = NULL)

    dialog_values <- getDialog("window_chr_convert", defaults)
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    upper_Frame <- tkframe(top)

    variableBox <-
        variableListBox2(upper_Frame,
                         variables_chr(),                                                     # [!!!] "character" is neaded
                         selectmode = "multiple",
                         title = gettext_Bio("Variables (pick one or more)"),
                         initialSelection = var_pos_n(dialog_values$variables, "character"), # [!!!] "character" is neaded
                         listHeight = 7
        )
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    into_outter_Frame <- tkframe(upper_Frame)
    radioButtons(into_outter_Frame,
                 name = "into",
                 title = gettext_Bio("Convert into"),
                 buttons = c("factor", "number", "integer", "logical"),
                 values  = c("factor", "number", "integer", "logical"),
                 initialValue = dialog_values$into,
                 labels =  gettext_Bio(
                     c("Factors",
                       "Real numbers",
                       "Integers",
                       "Logicals"))
    )
    # as_factor
    # parse_factor
    # parse_double
    # parse_integer
    # parse_logical

     # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    suffix      <- tclVar(dialog_values$suffix)
    suffixField <- ttkentry(top, width = "20", textvariable = suffix)
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    radioButtons_horizontal(name = "which_names",
                            title = gettext_Bio("Variables: "),
                            title.color = getRcmdr("title.color"),
                            buttons = c("new_names", "overwrite"),
                            values  = c("new_names", "overwrite"),
                            initialValue = dialog_values$which_names,
                            labels =  gettext_Bio(c("Create new", "Overwrite")))
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    onOK <- function() {
        suffix      <- trim.blanks(tclvalue(suffix))
        into        <- tclvalue_chr(intoVariable)
        which_names <- tclvalue_chr(which_namesVariable)
        variables   <- getSelection(variableBox)
        # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        putDialog("window_chr_convert",
                  list(suffix = {if (nchar(suffix) == 0) gettext_Bio("<automatic suffix>") else suffix},
                       into = into,
                       which_names = which_names,
                       variables = variables
                  )
        )
        # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        closeDialog()
        # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        if (length(variables) == 0) {
            errorCondition(recall = window_chr_convert,
                           message = gettext_Bio("You must select a variable."))
            return()
        }
        # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        .activeDataSet <- ActiveDataSet()

        switch(
            which_names,

            # Overwrite names ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
            "overwrite" = {
                new_names <- variables
            },

            # Use new names ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
            "new_names" = {
                new_names <-
                    if (suffix == gettext_Bio("<automatic suffix>")) {
                        suffix <- switch(into,
                                         "factor"  = "fct",
                                         "number"  = "num",
                                         "integer" = "int",
                                         "logical" = "lgl",
                                         into)
                        paste0(variables, "_", suffix)

                    } else if (length(variables) == 1) {
                        suffix

                    } else {
                        paste0(variables, suffix)
                    }

                # Check if new variable names are not duplicated ~~~~~~~~~~~~~~~~~~~~~~
                for (i in seq_along(variables)) {

                    if (!is.valid.name(new_names[i])) {
                        errorCondition(
                            recall = window_chr_convert,
                            message = paste(new_names[i], gettext_Bio("is not a valid name."))
                        )
                        return()
                    }
                    if (is.element(new_names[i], Variables())) {
                        if ("no" == tclvalue(checkReplace(new_names[i]))) {
                            window_chr_convert()
                            return()
                        }
                    }
                }
            }
        )
        # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

        Library("tidyverse")


        into_fun <- switch(into,
                           "factor"  = "forcats::as_factor"     ,
                           "number"  = "readr::parse_double"  ,
                           "integer" = "readr::parse_integer" ,
                           "logical" = "readr::parse_logical" ,
                           stop("Unexpected choice"))

        tans_txt <- glue("{new_names} = {into_fun}({variables})")

        command <-
            if (length(tans_txt) == 1) {
                glue("{.activeDataSet} <- {.activeDataSet} %>%\n",
                     "dplyr::mutate({tans_txt})\n")

            } else {
                glue("{.activeDataSet} <- {.activeDataSet} %>%\n",
                     'dplyr::mutate(\n{paste0(tans_txt, collapse = ",\n")}\n',
                     ')\n')
            }
        # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        command <- style_cmd(command)

        result <- justDoIt(command)

        if (class(result)[1] != "try-error")
            activeDataSet(.activeDataSet, flushModel = FALSE)

        # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        msg <- glue("#---  ", gettext_Bio("Convert text variables into"), " {into} variables ---#\n\n",
                    "# ", gettext_Bio("New variable(s):"), " \n",
                    paste("#   ", new_names, collapse = "\n"), "\n\n\n")

        logger(paste0(msg, command, collapse = "\n"))
        # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        tkfocus(CommanderWindow())
    } # [end: onOK] ----------------------------------------------------------
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    OKCancelHelp(helpSubject = "parse_atomic")
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    tkgrid(intoFrame, padx = c(15, 5))
    tkgrid(getFrame(variableBox), into_outter_Frame, sticky = "nw")

    tkgrid(upper_Frame)
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    tkgrid(which_namesFrame,
           sticky = "w",
           pady = c(10, 0))
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    tkgrid(labelRcmdr(top,
                      text = gettext_Bio("New variable name or suffix for multiple variables:"),
                      fg = getRcmdr("title.color")),
           sticky = "w",
           pady = c(10, 0))

    tkgrid(suffixField, sticky = "ew", columnspan = 2)
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    tkgrid(buttonsFrame, sticky = "ew", columnspan = 2)

    dialogSuffix(rows = 4,
                 columns = 2,
                 preventGrabFocus = TRUE)
}
# ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
